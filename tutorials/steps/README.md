If you have any questions or difficulties of using E3
please let us know by emailing to: `mm6446+e3@nyu.edu`

# Encrypt-Everything-Everywhere (E3)
## E3 framework

E3 is a framework for building and running C++ programs with
FHE (Fully Homomorphic Encryption).
The main philosophy of E3 is to make FHE programming enjoyable by being
as close to standard C++ as possible.
Other information can be found at [doc](doc).

## Quick gentle introduction

Examples for the following text are provided in `src/user/readme`.
Windows commands are given in the `.sh` files in the readme examples.

### Simple code, quick overview

The following program is an example of E3 program multiplying two numbers:
```C++
 #include <iostream>
 #include "e3int.h"

 int main()
 {
    SecureInt<32> a=2, b=3;
    std::cout << a * b << '\n';
 }

```

`e3int.h` is E3 header and `SecureInt` is a class generated by E3.
The security parameters come from a configuration file.
And the simplest working example of it is:
```C++
Secure : native {}
```
The output of the program is encrypted. For debug purposes it is possible
to recompile the program with decryption capabilities:
```C++
 #include <iostream>
 #include "e3int.h"
 #include "e3key.h"

 int main()
 {
    SecureInt<32> a=2, b=3;
    std::cout << e3::decrypt(a * b) << '\n';
 }
```

With the secret key the program outputs 6; and without it works as the original
outputting the encrypted result.


### Scenario and Parties

    +-----------------+                           +------------+
    |                 |       send bob.exe        |            |
    |      Alice      | +-----------------------> |    Bob     |
    |                 |                           |            |
    |  My C++ project |          result           |  untrusted |
    |  E3 framework   | <-----------------------+ |            |
    |                 |                           |            |
    +-----------------+                           +------------+

Alice uses E3 and prepared executable computing on encrypted data
and sends it to Bob. Bob runs the executable and sends the result
back to Alice. Alice decrypts the result

### E3 elements

      +----------------------------------------------------------+
      |                                                          |
      |                           E3                             |
      |                                                          |
      +------+--------------------+---------------------+--------+
             |                    |                     |
             v                    v                     v
          +--+---+          +-----+------+        +-----+------+
          | make |          | amalgam.sh |        | amalkey.sh |
          +--+---+          +-----+------+        +-----+------+
             |                    |                     |
             v                    |                     v
        +----+----+               |               +-----+------+
        | cgt.exe |               |               | cgtkey.cpp |
        +----+----+               |               +-----+------+
             |                    |                     |
             |                    |                     v
    +-----------------------------------------+     +---+-------+
    |        |                    |           +---->+ alice.exe |
    |        v                    v           |     +-----------+
    |  +-----+------+     +-------+-------+   |
    |  | secint.cpp |     | cgtshared.cpp |   |
    |  +------------+     +---------------+   |
    |                                         |
    |   +---------+                           |
    |   | My C++  |                           |       +---------+
    |   | project |                           +------>+ bob.exe |
    |   +---------+                           |       +---------+
    |                                         |
    +-----------------------------------------+


The diagram shows how to build two executables: `bob.exe` and `alice.exe`.
Alice sends `bob.exe` to Bob. Alice can use `alice.exe` to run ancillary
functions, i.e. custom encryption and decryption.
Two C++ examples above match `bob` and `alice` versions correspondingly.


### Step 1, trivial. Almost "Hello, World!"

Suppose we would like to build `bob.exe` out of our program `a.cpp`:
```C++
int main(){}
```
For this we need to
1. Build `cgt.exe`
2. Using cgt build `cgtshared.cpp`
3. Using cgt build `secint.cpp`
4. Compile all into `bob.exe`

First check out the E3 repository (let `$E3` be its path) and 
in `$E3/src` build `cgt.exe` and `cgtshared.cpp`.

    make
Then go to you project directory where `a.cpp` is, and run

    $E3/src/cgt.exe
which should print brief usage info. Command `gen` generates `secint.cpp`.
However, cgt also requires some information about security.
For this, create a file `cgt.cfg` with the following content:

    Native:native{}
Now cgt can be run

    $E3/src/cgt.exe gen -r $E3/src
This command scans all C++ files in the current directory and generates `secint.cpp`
along with its `.h` and `.inc` and with 2 keys: private and evaluation.

Now all ingredients are ready to be compiled.
Copy `cgtshared.cpp` to the current directory.

    cp $E3/src/cgtshared.* ./
And compile (e.g. with GCC):

    g++ -std=c++17 a.cpp secint.cpp cgtshared.cpp -o bob.exe
Any standard conforming C++ compiler can be used instead of GCC.
This should build the executable which does not do anything useful. 

### Step 2, with type

This time we include in out trivial C++ program a bogus secure type.
Let `a.cpp` now look like this:

``` c++
 #include <iostream>
 #include "e3int.h"

 int main()
 {
	SecureInt<8> a = _2_E;
	SecureInt<8> b = _3_E;
	std::cout << (a*b) << '\n';
 }

```

`SecureInt` is a class representing secure type. Its parameter `8`
is the bit size of the type.
The constants `_2_E` and `_3_E` are encryptions of 2 and 3.
The program outputs encryption of `6` `(=2*3)`.

Copy the header that includes `secint.h` and `secint.inc`:

    cp $E3/src/e3int.h ./
And modify the configuration file to:

    Secure : native
    {
        postfix = E
    }
Here `Secure` is the base name in `SecureInt` in the program. The program
could use also `SecureUint` and `SecureBool`.

Now regenerate classes according to the new configuration and rebuild the executable:

    $E3/src/cgt.exe gen -r $E3/src
    g++ -std=c++17 a.cpp secint.cpp cgtshared.cpp -o bob.exe
    ./bob.exe
prints `Secure[0000000000000806]` and

    ./bob.exe | $E3/src/cgt.exe dec
prints `6`. Here cgt tool was used to decrypt the output.


### Step 3, with security

First in `$E3/src` do

    make
The fist line builds `cgt.exe` and the second `cgtshared.h/cpp`.
Assume in your project directory you have your file `a.cpp` as in Step 2 above.
The configuration file `cgt.cfg` is set to:

    password = secret_phrase
    Secure : circuit
    {
        postfix = E
        encryption = tfhe
        sizes = 8
    }
Quick explanation about this file.
Password is used for generating keys. It can be set to any continuous string.
`circuit` is a keyword denoting that the secret type is bit-level:
each bit of the variable is encrypted independently.
Encryption defines the underlying encryption engine. In this case we chose TFHE.
`sizes` instruct CGT to include circuits for 8-bit size operands - this
corresponds to the template argument in the program.

Now in your project directory

    cp $E3/src/e3int.h ./
    cp $E3/src/cgtshared.* ./
    $E3/src/cgt.exe gen -r $E3/src
    g++ -std=c++17 a.cpp secint.cpp cgtshared.cpp -o bob.exe
    ./bob.exe | $E3/src/cgt.exe dec
prints 6 as expected.

### Step 4, Alice's computation

This example is to show how Alice's executable is built.

First change `a.cpp` to:
``` c++
 #include <iostream>

 #include "e3int.h"
 #include "e3key.h"

 int main()
 {
	SecureInt<8> a = _2_E;
	SecureInt<8> b = _3_E;
	std::cout << e3::decrypt(a*b) << '\n';
 }

```

Here we add `e3key.h` to include decryption function and change the output to decrypted.

In `$E3/src` do

    make
And in your project directory

    cp $E3/src/e3int.h ./
    cp $E3/src/e3key.h ./
    cp $E3/src/cgtshared.* ./
    cp $E3/src/cgtkey.* ./
    $E3/src/cgt.exe gen -r $E3/src
    g++ -std=c++17 -DE3KEY=1 a.cpp secint.cpp cgtshared.cpp cgtkey.cpp -o alice.exe

    ./alice.exe
Should print 6.


### Step 5, with real security

Above we used secure TFHE type, but no TFHE library was linked.
Instead a TFHE mock-up had been used.
In this step we add TFHE library in the build.
Go to `$E3/3p` and

    make TFHE
then in `$E3/src`

    make clean
    make TFHE=1
And as before we copy files and execute the program. However, this time we
include TFHE headers and TFHE library.

    cp $E3/src/e3int.h ./
    cp $E3/src/cgtshared.* ./
    $E3/src/cgt.exe gen -r $E3/src

    g++ -std=c++17 -I$e3/3p/tfhe_unx/inc/tfhe -I$e3/3p/tfhe_unx/inc/fftwa \
       -I$e3/3p/tfhe_unx/inc/fftw3 a.cpp secint.cpp cgtshared.cpp \
       -o bob.exe $e3/3p/tfhe_unx/target/libtfhe.a \
       $e3/3p/tfhe_unx/target/libfftw3.a

    ./bob.exe | $E3/src/cgt.exe dec
it prints 6 as expected.

Alice's executable can be built in the same manner as above in Step 4.




